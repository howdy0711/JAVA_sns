LAN의 모든 장비는 동일한 브로드 캐스트 도메인에 들어있다.

VLAN이 없다면, 모든 인터페이스가 동일한 브로드캐스트 도메인에 속하는 것으로
간주한다. 즉 스위치에 연결되어 있는 모든 장비가 동일한 LAN에있는 것이다.

그러나 VLAN을 적용할 경우 스위치의 일부 인터페이스를 하나의 브로드캐스트 도메인에 두고,
일부 인터페이스를 또 다른 브로드 캐스트 도메인에 둬서, 여러 개의 브로드 캐스트 도메인을 만들
수 있다.

VLAN의 이점
LAN이 클수록 호스트가 받는 브로드캐스트의 수와 종류는 많아지고, 결국
공격자는 호스트로 가는 프레임을 프로토콜 분석기 소프트웨어로 분석해 예비조사
공격을 진행한다.
이러한 이유 때문에 여러 VLAN으로 분리한다.

일반적인 사용이유 
1. 사용자를 물리적인 위치 대신 부서별로, 즉 함께 일하는 그룹별로 묶는 유연한 설계를 하기위함
2. 장비를 더작은 LAN(브로드 캐스트도메인)으로 분리해 VLAN의 각 호스트에서 일어나는
오버헤드를 줄이기 위해서다.
3. 별도의 VLAN에서 민감한 데이터를 처리하는 호스트의 보안을 강화하기 위해서다.
4. 전화기에 연결된 PC에서 전송한트래픽과 IP전화기에서 전송한 트래픽을 나누기 위해서다.

VLAN은 서로 떨어진, 물리적인 위치에 상관없이 할당이 가능하다.
S/W1에 VLAN 10,20,30
S/W2에 VLAN 10,20,30
의 VLAN을 가지고 있다면 서로 같은 VLAN 끼리 통신하기 위해서는
3개의 물리적인 연결이 필요하다. 
만약 100개의 VLAN을 가지고 있다면 100개의 물리적인 연결이 필요하다.
매우 비효율 적이다. 하지만 TRUNK포트를 사용하면 물리적인 포트하나로
여러개의 VLAN을 통신할 수 있다.

TRUNK크는 물리적인 포트하나에, 각각의 VLAN 태그를 붙여 
각각이 통신할수 있게 만드는 기술이다.

여기에 사용되는 프로토콜은
802.1Q와
ISL 프로토콜이 있고

ISL 프로토콜은, 시스코에서 자체적으로 만들어낸 프로토콜로, 시스코 장비끼리 통신이 가능하며
프레임에 새로운 헤더를 추가하여 TRUNK에 실어 보낸다.
ISL 방식은, 뒤에 설명할 NATIVE VLAN을 가지지 않고 모두 VLAN 정보를 태그한다.


802.1Q프로토콜은 표준으로 모든장비에서 사용이가능하다.
기존의 프레임 안에, 4BYTE 정보를 태그 시켜 TRUNK에 실어보낸다.
802.1Q프로토콜 방식은 태그되지않은 프레임은 NATIVE VLAN으로 간주하여 그곳의
VLAN으로 보낸다.

802.1Q
추가되는 TAG의 값

TPID

TPID 본래의 프레임에서 소스맥다음에  상위 프로토콜 타입 나온다
TPID 필드는 다음정보는 VLAN정보야라는 것을 알려준다.
값은 0x8100을 넣는다.


Priority

스위치에서 Qos를 적용할 수 있도록 data의 우선순위를 넣는 필드로
3bit이기때문에 0~7의 값을 가지고, 숫자가 높을 수록 높은 우선순위를 가진다.

CFI

본래 FRAME의 맥주소가 프레임이 이더넷 프레임인지,  토큰링프레임인지 구분한다.

VLAN ID
4096 VLAN ID를 지원하고 , 12BIT이다.

voice vlan
스위치 3은 vlan 150으로 태드된것이 voice 프레임들이라는 것을 지시한다.
우선적으로 voice프레임들을 포워딩하고,  vlan 20에서 데이터 프레임을 포워딩한다.


정상 범위의 vlan을 설정하는 경우, 세부 설정은 스위치의 플래시 메모리에 있는 vlan.dat라는 파일에 저장
되어있습니다. 플래시 메모리는 지속성이 있어서, copy runnung-config와 startup-config command
명령을 필요로 하지 않습니다.

정상범위 vlan은 vlan정보  runnig config 저장되고 백업본이  vlan.dat 에(flash) 저장된다.
확장범위 vlan은 vlan정보 가 running config 에 저장된다.

vlan을 만든후 다음 단계는 vlan에 포트를 할 당하는 것입니다. 액세스 포트는 한번에 하나의 vlan에
속할 수 있습니다. 이 규칙의 유일한 예외는 ip 전화에 연결되어있는 경우, 이 경우에는 한 포트에 2개의 
vlan이 연결되어 있습니다. 한개는 음성, 한개는 데이터 전용입니다.

전체 vlan.dat 파일은 delete flash:vlan.dat명령어를 사용하여 제거 할 수 있다.
카탈리스트 스위치의 경우 erase startup-config 명령은 이전 공장 상태로 스위치를 복원
하기위해 다시 로드 하기전에 반드시 delete vlan.dat 명령이 동반되어야 합니다.

VLAN 호핑은 스위치포트의 기본설정이 dynamic auto인것을 노리는 공격방법이다.
공격자가 802.1q와 dtp메시지를 모방하여서, 다른스위치가 트렁크형성을 시도하는것이라고 
속이게되면 공격자는, 그 트렁크 링크를 통해 모든 vlan대해서 액세스 할 수 있다.


